version: '3'

vars:
  GO_VERSION: '1.24'
  BUF_VERSION: '1.53.0'
  PROTOC_GEN_GO_VERSION: 'v1.36.6'
  PROTOC_GEN_GO_GRPC_VERSION: 'v1.5.1'
  PROTOC_GEN_GRPC_GATEWAY_VERSION: 'v2.26.3'
  PROTOC_GEN_VALIDATE_VERSION: 'v1.2.1'

  BIN_DIR: '{{.ROOT_DIR}}/bin'
  BUF: '{{.BIN_DIR}}/buf'
  PROTOC_GEN_GO: '{{.BIN_DIR}}/protoc-gen-go'
  PROTOC_GEN_GO_GRPC: '{{.BIN_DIR}}/protoc-gen-go-grpc'
  PROTOC_GEN_GRPC_GATEWAY: '{{.BIN_DIR}}/protoc-gen-grpc-gateway'
  PROTOC_GEN_VALIDATE: '{{.BIN_DIR}}/protoc-gen-validate'

  OPEN_API_ORDER_V1_BASE: '{{.ROOT_DIR}}/api/order/v1/order.openapi.yaml'
  OPEN_API_ORDER_V1_BUNDLE: '{{.ROOT_DIR}}/api/bundles/order.openapi.v1.bundle.yaml'
  OPEN_API_FILES: '{{.ROOT_DIR}}/api/bundles'


tasks:
  install-buf:
      desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Buf –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
      cmds:
        - |
          mkdir -p {{.BIN_DIR}}
          [ -f {{.BUF}} ] || {
            echo 'üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º buf {{.BUF_VERSION}}...'
            GOBIN={{.BIN_DIR}} go install github.com/bufbuild/buf/cmd/buf@v{{.BUF_VERSION}}
          }
      status:
        - test -x {{.BUF}}

  proto:install-plugins:
      desc: "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç protoc –ø–ª–∞–≥–∏–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ bin"
      cmds:
        - |
          [ -f {{.PROTOC_GEN_GO}} ] || {
            echo 'üì¶ Installing protoc-gen-go...'
            GOBIN={{.BIN_DIR}} go install google.golang.org/protobuf/cmd/protoc-gen-go@{{.PROTOC_GEN_GO_VERSION}}
          }
          [ -f {{.PROTOC_GEN_GO_GRPC}} ] || {
            echo 'üì¶ Installing protoc-gen-go-grpc...'
            GOBIN={{.BIN_DIR}} go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@{{.PROTOC_GEN_GO_GRPC_VERSION}}
          }
          [ -f {{.PROTOC_GEN_GRPC_GATEWAY}} ] || {
          echo 'üì¶ Installing protoc-gen-grpc-gateway...'
          GOBIN={{.BIN_DIR}} go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway@{{.PROTOC_GEN_GRPC_GATEWAY_VERSION}}
          }
          [ -f {{.PROTOC_GEN_VALIDATE}} ] || {
          echo 'üì¶ Installing protoc-gen-validate...'
          GOBIN={{.BIN_DIR}} go install github.com/envoyproxy/protoc-gen-validate@{{.PROTOC_GEN_VALIDATE_VERSION}}
          }
          [ -f {{.BIN_DIR}}/protoc-gen-openapiv2 ] || {
          echo 'üì¶ Installing protoc-gen-openapiv2...'
          GOBIN={{.BIN_DIR}} go install github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-openapiv2@latest
          }

  proto:update-deps:
      deps: [install-buf]
      desc: –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ protobuf –∏–∑ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ (googleapis –∏ —Ç.–¥.)
      dir: shared/proto
      cmds:
        - |
          echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ buf..."
          {{.BUF}} dep update

  proto:gen:
      deps: [ install-buf, proto:install-plugins, proto:update-deps ]
      desc: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Go-–∫–æ–¥–∞ –∏–∑ .proto
      env:
        PATH: "{{.BIN_DIR}}:{{.PATH}}"
      dir: proto
      cmds:
        - '{{.BUF}} generate'